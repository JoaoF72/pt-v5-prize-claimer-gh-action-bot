# .github/workflows/cron.optimism-mainnet.yml

name: CronJob – Prize Claimer Bot – Optimism

on:
  schedule:
    - cron: '*/5 * * * *'    # executa de 5 em 5 minutos
  workflow_dispatch:        # permite disparar manualmente via "Run workflow"

permissions: write-all

jobs:
  runCLI:
    name: Prize Claimer Bot
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 1
      matrix:
        node: ["20.11.1"]
        os: [ubuntu-latest]

    # ─────────── Variáveis de ambiente no nível do job ────────────
    env:
      JSON_RPC_URL: ${{ secrets.JSON_RPC_URL }}
      CUSTOM_RELAYER_PRIVATE_KEY: ${{ secrets.CUSTOM_RELAYER_PRIVATE_KEY }}
      CONTRACT_JSON_URL: 'https://raw.githubusercontent.com/GenerationSoftware/pt-v5-mainnet/396f04daedc5a38935460ddf47d2f10e9ac1fec6/deployments/optimism/contracts.json'
      SUBGRAPH_URL: 'https://api.goldsky.com/api/public/project_cm3xb1e8iup5601yx9mt5caat/subgraphs/pt-v5-optimism/v0.0.4/gn'
      CHAIN_ID: 10
      MIN_PROFIT_THRESHOLD_USD: -0.01
      REWARD_RECIPIENT: ''
      NODE_OPTIONS: "--max_old_space_size=32768"
    # ────────────────────────────────────────────────────────────────

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Use Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Store current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> "$GITHUB_ENV"

      - name: Store current time
        id: time
        run: echo "time=$(date +'%H-%M-%S_%Z')" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: npm ci

      - name: Run Prize Claimer Bot
        id: runBot
        run: npx tsx index.ts

      - name: Push changes (if required)
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          force: true

      - name: Comment on error
        if: steps.runBot.outcome == 'failure'
        uses: actions/github-script@v5
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Prize Claimer bot failed at ${process.env.date}_${process.env.time}`
            })
